generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  password     String
  name         String
  baekjoonName String
  department   String   @default("unknown")
  studentId    String
  rank         Int?
  tier         String?
  solvedNum    Int?
  createdAt    DateTime @default(now())
  profileImage  String?

  solvedProblems SolvedProblem[]
  snapshots      SolveSnapshot[]
  weeklyRanks    WeeklyRank[]
  posts   Post[]  // 사용자가 작성한 게시글 목록
  comments       Comment[] //사용자 댓글
  questSolves  QuestSolve[]
  userCards UserCard[] //사용자 카드
}

model SolveSnapshot {
  id          Int      @id @default(autoincrement())
  userId      Int
  solvedCount Int
  snapedAt    DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([snapedAt])
}

model WeeklyRank {
  id             Int      @id @default(autoincrement())
  weekStart      DateTime
  department     String
  userId         Int
  solvedThisWeek Int

  user User @relation(fields: [userId], references: [id])

  @@unique([weekStart, userId, department])
  @@index([weekStart, department])
}

model SolvedProblem {
  id        Int      @id @default(autoincrement())
  userId    Int
  problemId Int
  solvedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, problemId]) // 중복 방지하기 위해
}

model Post {
  id        Int       @id @default(autoincrement())
  title     String
  content   String
  code      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId  Int
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments  Comment[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuestSolve {
  userId    Int
  date      DateTime @db.DateTime(0) 
  problemId Int
  solvedAt  DateTime @default(now())

  user  User        @relation(fields:[userId], references:[id])

  @@id([userId, date, problemId])
}


model Card {
  id      Int    @id @default(autoincrement())
  title   String @unique
  comment String
  image   String

  ownedBy UserCard[]
}

model UserCard {
  id        Int      @id @default(autoincrement())
  userId    Int
  cardId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  card Card @relation(fields: [cardId], references: [id])

  @@unique([userId, cardId])
}
